<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bingo</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #1e1e1e; color: white; margin: 0; padding: 20px; text-align: center; }
        .hidden { display: none !important; }
        
        /* Lobby Styles */
        .btn { display: block; width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-blue { background: #3390ec; color: white; }
        .btn-green { background: #2ecc71; color: white; }
        .btn-gold { background: #f1c40f; color: #333; }
        
        /* Grid Styles */
        #game-screen { max-width: 400px; margin: 0 auto; }
        .grid-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 20px; }
        .cell { aspect-ratio: 1; background: #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; border: 2px solid transparent; }
        .cell.marked { background: #2ecc71; color: white; }
        .cell.called { border-color: #f1c40f; animation: pulse 1s infinite; }
        
        /* Stats Header */
        .header { display: flex; justify-content: space-between; margin-bottom: 20px; background: #2a2a2a; padding: 10px; border-radius: 10px; }
        .turn-indicator { padding: 10px; background: #e74c3c; border-radius: 8px; margin-bottom: 10px; font-weight: bold; }
        .my-turn { background: #2ecc71; }

        @keyframes pulse { 0% { border-color: #f1c40f; } 50% { border-color: transparent; } 100% { border-color: #f1c40f; } }
    </style>
</head>
<body>

    <div id="lobby-screen">
        <h1>üé± Bingo Online</h1>
        <p id="connection-status" style="color: yellow;">Connecting...</p>
        
        <div id="menu-area" class="hidden">
            <h3>Start a New Game</h3>
            <button class="btn btn-blue" onclick="createGame(100)">ü•â Bronze (100 ü™ô)</button>
            <button class="btn btn-green" onclick="createGame(500)">ü•à Silver (500 ü™ô)</button>
            <button class="btn btn-gold" onclick="createGame(1000)">ü•á Gold (1k ü™ô)</button>
        </div>
    </div>

    <div id="game-screen" class="hidden">
        <div class="header">
            <span id="player-name">Player</span>
            <span>üí∞ Pot: <span id="pot-display">0</span></span>
        </div>
        
        <div id="turn-box" class="turn-indicator">Waiting for players...</div>
        
        <div class="grid-container" id="grid">
            </div>

        <button id="bingo-btn" class="btn btn-gold hidden" onclick="claimBingo()">üèÜ CLAIM BINGO!</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const user = tg.initDataUnsafe.user || {id: 12345, first_name: "TestUser"};

        // 1. Get Backend URL from the Bot's Link
        const urlParams = new URLSearchParams(window.location.search);
        let API_URL = urlParams.get('api');
        
        // Fallback for testing in browser without bot
        if (!API_URL) API_URL = prompt("Enter Backend URL (from Termux):", "https://your-url.trycloudflare.com");

        // Clean URL for WebSocket
        const WS_URL = API_URL.replace("https://", "wss://");
        let socket;
        let currentMatchId = null;

        // --- CONNECT TO BACKEND ---
        function connect() {
            socket = new WebSocket(`${WS_URL}/ws/lobby/${user.id}`);
            
            socket.onopen = () => {
                document.getElementById("connection-status").innerText = "‚úÖ Connected!";
                document.getElementById("connection-status").style.color = "#2ecc71";
                document.getElementById("menu-area").classList.remove("hidden");
            };

            socket.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleMessage(msg);
            };

            socket.onclose = () => {
                document.getElementById("connection-status").innerText = "‚ùå Disconnected";
                document.getElementById("connection-status").style.color = "red";
            };
        }

        // --- GAME LOGIC ---
        async function createGame(fee) {
            try {
                // Call the Create API
                const res = await fetch(`${API_URL}/create_lobby?user_id=${user.id}&entry_fee=${fee}`, { method: "POST" });
                const data = await res.json();
                
                if (data.status === "success") {
                    enterGame(data.match_id);
                } else {
                    alert("Error: " + JSON.stringify(data));
                }
            } catch (e) {
                alert("Connection Failed: " + e);
            }
        }

        function enterGame(matchId) {
            currentMatchId = matchId;
            document.getElementById("lobby-screen").classList.add("hidden");
            document.getElementById("game-screen").classList.remove("hidden");
            generateGrid();
        }

        function generateGrid() {
            const grid = document.getElementById("grid");
            grid.innerHTML = "";
            // Simple 1-25 Grid for now (In real game, shuffle this)
            for (let i = 1; i <= 25; i++) {
                let cell = document.createElement("div");
                cell.className = "cell";
                cell.innerText = i;
                cell.onclick = () => {
                    // Visual mark only (Server validation later)
                    cell.classList.toggle("marked");
                };
                grid.appendChild(cell);
            }
        }

        function handleMessage(msg) {
            console.log("Received:", msg);
            // Here we will handle "YOUR TURN" and "NUMBER CALLED" events later
        }

        // Start
        connect();
    </script>
</body>
  </html>
  
